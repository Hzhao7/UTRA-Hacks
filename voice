import serial, requests, time, pygame, snowflake.connector, warnings, os

# Silence Snowflake connector warnings
warnings.filterwarnings("ignore", category=UserWarning, module='snowflake.connector')

# --- 1. CONFIGURATION ---
SNOW_ACCOUNT  = "QDYVRUA-OR78988"
SNOW_USER     = "pandapan"
SNOW_PASS     = "HelloMellow100%"  # Using password for a fail-proof hackathon demo

ELEVEN_KEY    = "sk_3b39e08245b9403319baab02963c4a9bb70e7d1154481315"
VOICE_ID      = "N2lVS1w4EtoT3dr4eOWO"

# Adjust COM port: Mac: '/dev/cu.usbmodem...' or Windows: 'COM3'
ARDUINO_PORT  = '/dev/cu.usbmodem101'
BAUD_RATE     = 9600

# --- 2. INITIALIZATION ---
pygame.mixer.init()

try:
    print("Connecting to Snowflake (Username/Password)...")
    conn = snowflake.connector.connect(
        user=SNOW_USER, 
        password=SNOW_PASS,
        account=SNOW_ACCOUNT,
        role="ACCOUNTADMIN",
        warehouse="COMPUTE_WH", 
        database="SNOWFLAKE_LEARNING_DB", 
        schema="PUBLIC"
    )
    cursor = conn.cursor()
    print("âœ… Snowflake Brain Online!")
except Exception as e:
    print(f"âŒ Connection Failed: {e}")
    exit()

try:
    ser = serial.Serial(ARDUINO_PORT, BAUD_RATE, timeout=0.1)
    print(f"âœ… Connected to Arduino on {ARDUINO_PORT}")
except Exception as e:
    print(f"âŒ Arduino not found: {e}. Check COM port/USB cable!")
    exit()

# --- 3. LOGIC FUNCTIONS ---

def get_commentary(dist, color):
    """Fetches a funny sports line from Snowflake Cortex."""
    # We use a very specific prompt to keep it short and energetic
    prompt = (f"Act as a frantic, high-energy sports commentator. "
              f"The robot is {dist}cm away on a {color}. "
              f"Give me ONE short, hilarious, and high-energy sentence. Do not use quotes.")
    
    # Clean prompt to prevent SQL errors
    safe_prompt = prompt.replace("'", "''")
    
    # Using 'mistral-large' for faster response times
    sql = f"SELECT SNOWFLAKE.CORTEX.COMPLETE('mistral-large', '{safe_prompt}')"
    
    try:
        cursor.execute(sql)
        result = cursor.fetchone()
        return result[0].strip()
    except Exception as e:
        print(f"AI Error: {e}")
        return "He's absolutely flying across the track!"

def speak(text):
    """Generates audio via ElevenLabs and plays it."""
    url = f"https://api.elevenlabs.io/v1/text-to-speech/{VOICE_ID}"
    headers = {"xi-api-key": ELEVEN_KEY, "Content-Type": "application/json"}
    payload = {"text": text, "model_id": "eleven_turbo_v2_5"}

    try:
        res = requests.post(url, json=payload, headers=headers, timeout=5)
        if res.status_code == 200:
            with open("voice.mp3", "wb") as f:
                f.write(res.content)
            
            pygame.mixer.music.load("voice.mp3")
            pygame.mixer.music.play()
    except Exception as e:
        print(f"Audio Error: {e}")

# --- 4. MAIN LOOP ---
print("\nğŸš€ Ready! Place the robot on the track.")

if __name__ == "__main__":
    while True:
        line = ""
        if ser.in_waiting > 0:
            # We only care about the MOST RECENT line from the robot
            while ser.in_waiting > 0:
                line = ser.readline().decode('utf-8', errors='ignore').strip()
        
        # JUNK FILTER: Only process lines like "10,RED_ZONE"
        if "," in line and not pygame.mixer.music.get_busy():
            try:
                parts = line.split(",")
                if len(parts) == 2:
                    dist, color = parts[0], parts[1]
                    
                    # 1. Generate text
                    commentary = get_commentary(dist, color)
                    print(f"ğŸ™ï¸ AI: {commentary}")
                    
                    # 2. Speak text
                    speak(commentary)
            except Exception:
                pass # Ignore lines that don't fit the format

        time.sleep(0.1)